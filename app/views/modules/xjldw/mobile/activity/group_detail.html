<!DOCTYPE HTML>
<html ng-app="app">
<head>
<title>团购</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport"
	          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,minimal-ui"/>
	
	<meta content="yes" name="apple-mobile-web-app-capable" />
	<meta content="yes" name="apple-touch-fullscreen" />
	<meta content="telephone=no" name="format-detection" />
	<meta content="black" name="apple-mobile-web-app-status-bar-style" />
	<link rel="stylesheet" href="/dw/public/css/main.css" />
	<link rel="stylesheet" href="/dw/public/css/weui.css" />
	<link rel="stylesheet" href="/dw/public/css/weui2.css"/>
	<link rel="stylesheet" href="/dw/public/css/weui3.css"/>
</head>

<body  ng-controller="MainController"  style="background-color:white;">
<div class="main" >
<div id="scroller" class="row posrel page__bd page__bd_spacing" ng-show="showSummary==true">
<div class="weui-flex" style="line-height:50px;">
   <div class="weui-flex__item"><strong>{{title}}</strong></div>
</div>
<div class="weui-flex">
        <div class="weui-flex__item"><div class="">参与人数:{{totalBuyer}}</div></div>
        <div class="weui-flex__item"><div style="float:left;">购买数量:{{totalCount}}</div></div>
</div>
<div class="weui-flex" style="line-height:50px;">
         <div class="weui-flex__item"><div class="">合计金额:{{totalAmount}}</div></div>
</div>
<div class="weui-flex" style="line-height:50px;vertical-align:inherit;">
     <div class="weui-flex__item"><strong>明细:</strong></div>
     <div class="weui-flex__item"><div> <!-- <a href="javascript:;" id="all" class="weui-btn weui-btn_mini weui-btn_primary" ng-click="switchSummary(false)">切换汇总</a> --></div></div>
</div>
<div id="data" class="content"   ng-repeat="studentInfo in itemInfoList">
<div class="weui-flex">
        <div class="weui-flex__item"><div class="">{{studentInfo.gatherStudentName}}</div></div>
        <div class="weui-flex__item"><div class="">合计:{{studentInfo.gatherPrice}}元{{studentInfo.gatherQuantity}}个</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_1 != 'null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_1 == 'true'"  ><strong style="color: #75bc00;">{{studentInfo.param_1}}</strong><strong>({{studentInfo.param_1_buy_num}})</strong></div>
   <div class="weui-flex__item" ng-show="studentInfo._param_1 =='false'"><div>{{studentInfo.param_1}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_2 !='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_2 =='true'" ><strong style="color: #75bc00;">{{studentInfo.param_2}}</strong><strong>({{studentInfo.param_2_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_2 =='false'"><div >{{studentInfo.param_2}}</div></div>
</div>
<div class="weui-flex" ng-if="studentInfo.param_3 != 'null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_3 =='true'"><strong style="color: #75bc00;"  >{{studentInfo.param_3}}</strong><strong>({{studentInfo.param_3_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_3=='false'"><div >{{studentInfo.param_3}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_4 != 'null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_4 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_4}}</strong><strong>({{studentInfo.param_4_buy_num}})</strong></div>
   <div class="weui-flex__item" ng-show="studentInfo._param_4 == 'false'"><div >{{studentInfo.param_4}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_5 !='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_5 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_5}}</strong><strong>({{studentInfo.param_5_buy_num}})</strong></div>
   <div class="weui-flex__item" ng-show="studentInfo._param_5 == 'false'"><div >{{studentInfo.param_5}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_6!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_6 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_6}}</strong><strong>({{studentInfo.param_6_buy_num}})</strong></div>
     <div class="weui-flex__item" ng-show="studentInfo._param_6 == 'false'"><div >{{studentInfo.param_6}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_7!='null'">
   <div class="weui-flex__item"  ng-show="studentInfo._param_7 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_7}}</strong><strong>({{studentInfo.param_7_buy_num}})</strong></div>
    <div class="weui-flex__item"  ng-show="studentInfo._param_7 == 'false'"><div >{{studentInfo.param_7}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_8!='null'">
   <div class="weui-flex__item"  ng-show="studentInfo._param_8 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_8}}</strong><strong>({{studentInfo.param_8_buy_num}})</strong></div>
    <div class="weui-flex__item"  ng-show="studentInfo._param_8 =='false'"><div >{{studentInfo.param_8}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_9!='null'">
   <div class="weui-flex__item"  ng-show="studentInfo._param_9 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_9}}</strong><strong>({{studentInfo.param_9_buy_num}})</strong></div>
    <div class="weui-flex__item"  ng-show="studentInfo._param_9 == 'false'"><div >{{studentInfo.param_9}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_10!='null'">
   <div class="weui-flex__item"  ng-show="studentInfo._param_10 == 'true'"><strong style="color: #75bc00;" >{{studentInfo.param_10}}</strong><strong>({{studentInfo.param_10_buy_num}})</strong></div>
    <div class="weui-flex__item"  ng-show="studentInfo._param_10 =='false'"><div >{{studentInfo.param_10}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_11!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_11 =='true'"><strong style="color: #75bc00;">{{studentInfo.param_11}}</strong><strong>({{studentInfo.param_11_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_11 == 'false'"><div >{{studentInfo.param_11}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_12!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_12 == 'true'"><strong style="color: #75bc00;">{{studentInfo.param_12}}</strong><strong>({{studentInfo.param_12_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_12 == 'false'"><div >{{studentInfo.param_12}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_13!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_13=='true'"><strong style="color: #75bc00;">{{studentInfo.param_13}}</strong><strong>({{studentInfo.param_13_buy_num}})</strong></div>
   <div class="weui-flex__item" ng-show="studentInfo._param_13=='false'"><div >{{studentInfo.param_13}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_14!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_14 =='true'"><strong style="color: #75bc00;">{{studentInfo.param_14}}</strong><strong>({{studentInfo.param_14_buy_num}})</strong></div>
     <div class="weui-flex__item" ng-show="studentInfo._param_14 =='false'"><div >{{studentInfo.param_14}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_15!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_15 == 'true'"><strong style="color: #75bc00;">{{studentInfo.param_15}}</strong><strong>({{studentInfo.param_15_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_15 == 'false'"><div >{{studentInfo.param_15}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_16!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_16=='true'"><strong style="color: #75bc00;">{{studentInfo.param_16}}</strong><strong>({{studentInfo.param_16_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_16=='false'"><div >{{studentInfo.param_16}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_17!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_17 == 'true'"><strong style="color: #75bc00;">{{studentInfo.param_17}}</strong><strong>({{studentInfo.param_17_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_17 == 'false'"><div >{{studentInfo.param_17}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_18!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_18 =='true'"><strong style="color: #75bc00;">{{studentInfo.param_18}}</strong><strong>({{studentInfo.param_18_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo.param_18 =='false'"><div >{{studentInfo.param_18}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_19!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_19 =='true'"><strong style="color: #75bc00;">{{studentInfo.param_19}}</strong><strong>({{studentInfo.param_19_buy_num}})</strong></div>
   <div class="weui-flex__item" ng-show="studentInfo._param_19 =='false'"><div >{{studentInfo.param_19}}</div></div>
</div>
<div class="weui-flex" ng-show="studentInfo.param_20!='null'">
   <div class="weui-flex__item" ng-show="studentInfo._param_20 =='true'"><strong style="color: #75bc00;">{{studentInfo.param_20}}</strong><strong>({{studentInfo.param_20_buy_num}})</strong></div>
    <div class="weui-flex__item" ng-show="studentInfo._param_20=='false'"><div >{{studentInfo.param_20}}</div></div>
</div>
<h3 class="padded-b-10 border-b  padded-t-10 text-default"></h3>
</div>
 <div class="margin-t-15 margin-b-15 clearfix">
      <span>截止:{{endTime}}</span>
      <input ng-show="${wxUser.isCommittee}==true && state=='1'" type="button" class="btn fr wid45 line-height-2 bg-warning" ng-click="closeGroupBuy()" value="现在关闭"/>
      <input ng-show="${wxUser.isCommittee}==false && state=='1'" type="button" class="btn fr wid45 line-height-2 bg-warning" value="进行中"/>
      <input ng-show="state=='2'" type="button" class="btn fr wid45 line-height-2" style="background-color:gray;" value="已结束"/>
    </div>
</div>
<!-- <div class="main">
  <div class="row posrel" ng-show="showSummary==true">
   <div class="tabbtn">
      <input type="button" value="切换汇总" class="btn btn-blue" ng-click="switchSummary(false)"/>
    </div>
    <div class="padded-t-10">人数：<span class="font-size-16 font-weight-b">{{totalBuyer}}&nbsp;</span>
         <span>金额：{{totalAmount}}元</span>&nbsp;&nbsp;<span>数量：{{totalCount}}</span>
    </div>
    <div class="padded-t-10 padded-b-10">购买数量统计：<input type="button" value="导出" class="btn btn-blue" ng-click="print()"/> </div>
    <div class="padded-t-10 border-b" ng-repeat="studentInfo in studentInfoList">
      <p class="padded-10"><span class="padded-r-10">{{studentInfo.name}}</span>
      <span ng-repeat="item in studentInfo.itemInfo">
      	<span ng-show="item.isOrder=='true'" class=" padded-l-10 padded-r-10 padded-b-5 padded-t-5 margin-l-10 bg-success text-white" >{{item.itemTitle}}</span>
      	<span ng-show="item.isOrder=='false'" class=" padded-l-10 padded-r-10 padded-b-5 padded-t-5 margin-l-10" >{{item.itemTitle}}</span>
      </span>
      <p class="padded-10">合计：{{studentInfo.count}}个，{{studentInfo.amount}}元</p>
    </div>
    <div class="margin-t-15 margin-b-15 clearfix">
      <span>截止:{{endTime}}</span>
      <input ng-show="state=='1'" type="button" class="btn fr wid45 line-height-2 bg-warning" ng-click="closeGroupBuy()" value="现在关闭"/>
      <input ng-show="state=='2'" type="button" class="btn fr wid45 line-height-2 bg-warning" value="已结束"/>
    </div>
  </div>
<div class="row posrel" ng-show="showSummary==false">
    <div class="tabbtn">
      <input type="button" value="切换明细" class="btn btn-blue" ng-click="switchSummary(true)"/>
    </div>
    <div class="padded-t-10">人数：<span class="font-size-16 font-weight-b">{{totalBuyer}}&nbsp;</span>
         <span>金额：{{totalAmount}}元</span>&nbsp;&nbsp;<span>数量：{{totalCount}}</span>
    </div>
    <div class="padded-t-10 padded-b-10 hide">购买数量统计：</div>
    <div class="padded-t-10" id="groupEcharts" style="height:400px;"> 
    </div>
    <div class="margin-t-15 margin-b-15 clearfix">
      <span>截止:{{endTime}}</span>
      <input ng-show="${wxUser.isCommittee}==true && state=='1'" type="button" class="btn fr wid45 line-height-2 bg-warning" ng-click="closeGroupBuy()" value="现在关闭"/>
      <input ng-show="${wxUser.isCommittee}==false && state=='1'" type="button" class="btn fr wid45 line-height-2 bg-warning" value="进行中"/>
      <input ng-show="state=='2'" type="button" class="btn fr wid45 line-height-2 bg-warning" value="已结束"/>
    </div>
  </div> 
 --></div>
<script src="/dw/public/widgets/layer.m/layer.m.js"></script>
<script src="/dw/public/widgets/zeptojs/zepto.min.js"></script>
<script src="/dw/public/widgets/dropload/dropload.min.js"></script>
<script src="/dw/public/widgets/angularjs/angular.min.js"></script>
<script src="/dw/public/widgets/angularjs/angular-touch.min.js"></script>
<script>
    angular.module('app', ['ngTouch'])
    .value('appValue', {
			    index: 1,
			    size: 50
			})
            .factory('remote', ['$http','appValue', function ($http,appValue) {
                return {
                	queryGroupStatistics: function (groupBuyId,index,size,searchText) {
                        return $http({
                            method: 'GET',
                            url: '/dw/mobile/ActivityService/queryGroupGatherStatistics',
                            params: {
                            	groupBuyId:groupBuyId,
                            	PAGE_INDEX: index || appValue.index,
                                PAGE_SIZE: size || appValue.size
                            }
                        })
                    },
                    queryChart:function(groupBuyId){
                    	return $http({
                            method: 'GET',
                            url: '/dw/mobile/ActivityService/queryChart',
                            params: {
                            	groupBuyId:groupBuyId
                            }
                        })
                    },
                    queryChart:function(groupBuyId){
                    	return $http({
                            method: 'GET',
                            url: '/dw/mobile/ActivityService/queryChart',
                            params: {
                            	groupBuyId:groupBuyId
                            }
                        })
                    },
                    printExcel:function(groupBuyId){
                    	return $http({
                            method: 'GET',
                            url: '/dw/mobile/ActivityService/printExcel',
                            params: {
                            	groupBuyId:groupBuyId
                            }
                        })
                    },
                    closeGroupBuy: function (groupBuyId) {
                        return $http({
                            method: 'GET',
                            url: '/dw/mobile/ActivityService/closeGroupBuy',
                            params: {
                            	groupBuyId:groupBuyId
                            }
                        })
                    }
                };
            }])
            .controller('MainController', ['$scope','appValue', 'remote', function ($scope,appValue, remote) {
            	$scope.showSummary=true;
            	$scope.title;//标题
            	$scope.titleSplit;//检测标题内容
            	$scope.titleSplitCount;//检测标题长度
            	$scope.state;//状态，1进行中，2结束
            	$scope.totalBuyer=0;//团购人数
             	$scope.totalAmount=0;//团购金额
             	$scope.totalCount=0;//团购的明细数量
             	$scope.endTime;//团购截止日志
             	$scope.closeFlag;//团购结束标识
            	$scope.itemInfoList=[];//团购明细
             	$scope.studentInfoList=[];//学生信息列表
             	/* $("#groupEcharts").width($(window).width());
             	$scope.initChart = function(me){
            		 remote.queryChart('${groupBuyId}').then(function (response) {
            			var itemInfoList = response.data.data.itemInfoList;
            			$scope.titleSplit = response.data.data.titleSplit;
            			$scope.titleSplitCount = response.data.data.titleSplitCount;
            			 console.log('titleSplit:'+$scope.titleSplit);
                         console.log('titleSplitCount:'+response.data.data.titleSplitCount);
            			var myChart = echarts.init(document.getElementById('groupEcharts'));
                       var chartTitleList = [];
                       var chartDataList = [];
   					for (var i = 0; i < itemInfoList.length; i++){
   						if($scope.titleSplitCount > 5 && $scope.titleSplit !=""){
   							var title =itemInfoList[i].title;
							chartTitleList[i]=title.replace(new RegExp($scope.titleSplit,"gm"),"");
						}else{
							chartTitleList[i]=itemInfoList[i].title;
						}
   						chartDataList[i]=itemInfoList[i].buyerCount;
   						$scope.totalCount+=parseInt(itemInfoList[i].buyerCount);
   					}
                       // 指定图表的配置项和数据
                       var option = {
                           title: {
                               text: '购买数量统计:'
                           },
                           tooltip: {},
                           legend: {
                               data:['销量']
                           },
                           xAxis: {
                           	axisLabel :{  
                                   interval:0 ,
                                   rotate:45,
                                   margin:2,
                                   textStyle:{
                                   	color:"#222"
                                   }
                               } ,
                               data: chartTitleList
                           },
                           yAxis: {},
                           series: [{
                               name: '销量',
                               type: 'bar',
                               data:chartDataList
                           }]
                       };
                       // 使用刚指定的配置项和数据显示图表。
                       myChart.setOption(option);
                       if (me && me.resetload)
                           me.resetload();
            		 });
            	} */
           	 $scope.nextPage = function(me){
         		remote.queryGroupStatistics('${groupBuyId}',++appValue.index).then(function(response){
         			if(response.data.data.data.length >0){
         				$scope.itemInfoList = response.data.data.data;
	                    	$scope.title = response.data.data.data[0].groupbuyTitle;
	                    	$scope.totalBuyer = response.data.data.allBuypeopleCount;
	                    	$scope.totalAmount = response.data.data.allprice;
	                    	$scope.totalCount = response.data.data.allQuantity;
	                    	$scope.endTime = response.data.data.endTime;
	                    	$scope.state = response.data.data.state;
	                    	console.log(response.data.data.data);
         			}
						 if (me && me.resetload)
	                         me.resetload();
					 },function(response){
						 
					 })
				 };
                $scope.initPage = function (me) {
                    remote.queryGroupStatistics('${groupBuyId}',1).then(function (response) {
                    	if(response.data.data.data.length >0){
                        	$scope.itemInfoList = response.data.data.data;
                        	$scope.title = response.data.data.data[0].groupbuyTitle;
                        	$scope.totalBuyer = response.data.data.allBuypeopleCount;
                        	$scope.totalAmount = response.data.data.allprice;
                        	$scope.totalCount = response.data.data.allQuantity;
                        	$scope.endTime = response.data.data.endTime;
                        	$scope.state = response.data.data.state;
                        	console.log(response.data.data.data);
                        	}
                        if (me && me.resetload)
                            me.resetload();
                    }, function (response) {
                        //err
                    });
                };
                $scope.initPage();
                // 基于准备好的dom，初始化echarts实例
                //手动关闭团购
                $scope.closeGroupBuy=function(){
                        remote.closeGroupBuy('${groupBuyId}')
                                .then(function (res) {
                                    if (res.data.ret=='-1') {
                                        layer.open({
                                            content: res.data.desc,
                                            btn: ['知道了']
                                        });
                                    }
                                    else {
                                        layer.open({
                                            content: "团购关闭成功",
                                            btn: ['确定'],
                                            end: function () {
                                                location.href = "/dw/mobile/A/groupList";
                                            }
                                        });
                                    }
                                }, function () {
                                    layer.open({
                                        content: '提交异常',
                                        btn: ['知道了']
                                    });

                                }).finally(function () {
                                    layer.close(index);
                                });
                   
                };
                $scope.back= function () {
                	location.href = "/dw/mobile/A/groupList";
                };
                $scope.switchSummary=function(flag){
                   $scope.showSummary=flag;
                }
                $('#scroller').dropload({
                    domUp: {
                        domClass: 'dropload-up',
                        domRefresh: '<div class="dropload-refresh">↓下拉刷新</div>',
                        domUpdate: '<div class="dropload-update">↑释放更新</div>',
                        domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
                    },
                    domDown: {
                        domClass: 'dropload-down',
                        domRefresh: '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domUpdate: '<div class="dropload-update">↓释放加载</div>',
                        domLoad: '<div class="dropload-load"><span class="loading"></span>加载中...</div>'
                    },
                    scrollArea: window,
                    loadUpFn: function (me) {
                    	 $scope.nextPage(me);
                        console.log('down');
                    },
                    loadDownFn: function (me) {
                        $scope.nextPage(me);
                        console.log('up');
                    }
                });
            }]);
</script>
</body>
</html>
